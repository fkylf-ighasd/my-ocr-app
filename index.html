<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>精密帳票OCR</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; overflow: hidden; height: 100dvh; }
        #main-container { position: relative; width: 100%; height: 100dvh; }
        
        /* カメラ映像 */
        #camera-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; }
        video, #preview-img { width: 100%; height: 100%; object-fit: cover; }
        #preview-img { position: absolute; top: 0; left: 0; z-index: 5; display: none; }

        /* ガイド */
        #guide-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            height: 80dvh; aspect-ratio: 74 / 210;
            border: 2px solid rgba(0, 255, 0, 0.5);
            box-shadow: 0 0 0 100vmax rgba(0,0,0,0.7);
            z-index: 10; pointer-events: none;
        }
        .guide-box { position: absolute; border: 1px solid rgba(255, 50, 50, 0.8); background: rgba(255, 50, 50, 0.1); }
        #g-no { right: 9.46%; top: 10%; width: 10.81%; height: 14.29%; }
        #g-model { right: 20.27%; top: 10%; width: 10.81%; height: 46.67%; }
        #g-part { right: 31.08%; top: 10%; width: 10.81%; height: 46.67%; }

        /* UIエリア：ここを見やすく修正 */
        #controls { 
            position: absolute; bottom: 30px; left: 0; width: 100%; 
            text-align: center; z-index: 30; 
        }
        #status-bar { 
            background: rgba(0,0,0,0.7); display: inline-block; padding: 5px 15px;
            margin-bottom: 10px; font-size: 14px; color: #0f0; border-radius: 10px;
        }
        button#cap-btn {
            display: block; margin: 0 auto; width: 80%; padding: 18px; 
            font-size: 18px; font-weight: bold; border-radius: 50px;
            border: 2px solid #fff; background: rgba(40, 167, 69, 0.8); color: #fff;
        }
        button:disabled { background: #444; border-color: #666; }
    </style>
</head>
<body>

<div id="main-container">
    <div id="camera-view">
        <video id="video" autoplay playsinline muted></video>
        <img id="preview-img">
        <div id="guide-container">
            <div id="g-no" class="guide-box"></div>
            <div id="g-model" class="guide-box"></div>
            <div id="g-part" class="guide-box"></div>
        </div>
    </div>
    
    <div id="controls">
        <div id="status-bar">初期化中...</div>
        <button id="cap-btn" disabled>スキャン開始</button>
    </div>
</div>

<canvas id="canvas-upload" style="display:none;"></canvas>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzY9KvGkYZDUG_9IFy5q91cj5A0jnpePuGIDLfaUG8nY9Gx7jDuEMY5lyoazQMNmzFBsg/exec";
    const video = document.getElementById('video');
    const status = document.getElementById('status-bar');
    const btn = document.getElementById('cap-btn');
    const previewImg = document.getElementById('preview-img');
    const canvasUpload = document.getElementById('canvas-upload');

    let worker = null;

    // OCRエンジンの初期化
    async function initOCR() {
        try {
            status.innerText = "OCRエンジン起動中...";
            worker = await Tesseract.createWorker('jpn');
            status.innerText = "準備完了";
            btn.disabled = false;
        } catch (e) {
            status.innerText = "OCR起動失敗。再読み込みしてください";
            console.error(e);
        }
    }

    // カメラの初期化
    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } }
            });
            video.srcObject = stream;
            await initOCR();
        } catch (err) {
            status.innerText = "カメラを許可してください";
        }
    }

    btn.onclick = async () => {
        btn.disabled = true;
        
        // 1. 画像キャプチャ（回転込み）
        const vW = video.videoWidth;
        const vH = video.videoHeight;
        canvasUpload.width = vH; 
        canvasUpload.height = vW;
        const ctx = canvasUpload.getContext('2d');
        ctx.translate(canvasUpload.width/2, canvasUpload.height/2);
        ctx.rotate(-90 * Math.PI / 180);
        ctx.drawImage(video, -vW/2, -vH/2);

        previewImg.src = canvasUpload.toDataURL('image/jpeg');
        previewImg.style.display = 'block';

        // 解析エリア設定
       // ...（中略：キャプチャ部分はそのまま）

    // 解析エリアと、それぞれの「読み取りルール」を設定
    const areas = [
        { id: 'no',    label: 'No.',   r: 9.6,  t: 10.5, w: 10.4, h: 13.5, whitelist: '0123456789' }, // 数字のみ
        { id: 'model', label: '型式',  r: 20.4, t: 10.5, w: 10.4, h: 45.5, whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-' }, // 英数
        { id: 'part',  label: '部品名', r: 31.2, t: 10.5, w: 10.4, h: 45.5, whitelist: '' } // 制限なし
    ];

    const results = {};

    try {
        for (let i = 0; i < areas.length; i++) {
            const a = areas[i];
            status.innerText = `${a.label}を読取中...`;

            const tmp = document.createElement('canvas');
            const tCtx = tmp.getContext('2d');
            
            // 座標計算（枠線を踏まないようさらに0.2-0.5%内側へ）
            const w = Math.floor((a.w/100) * canvasUpload.width);
            const h = Math.floor((a.h/100) * canvasUpload.height);
            const x = Math.floor(canvasUpload.width - ((a.r/100) * canvasUpload.width) - w);
            const y = Math.floor((a.t/100) * canvasUpload.height);

            tmp.width = w; tmp.height = h;

            // 画像処理：コントラストを上げるためのグレースケール化
            tCtx.filter = 'grayscale(1) contrast(1.2)'; 
            tCtx.drawImage(canvasUpload, x, y, w, h, 0, 0, w, h);

            // OCR実行（ホワイトリストを適用）
            const options = a.whitelist ? { tessedit_char_whitelist: a.whitelist } : {};
            const { data: { text } } = await worker.recognize(tmp, options);
            
            // 改行やゴミを除去
            results[a.id] = text.replace(/[\s\n\r]/g, ""); 
        }

        // ...（以下、GAS送信部分はそのまま）

            status.innerText = "シートに送信中...";
            await fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify({
                    no: results.no,
                    model: results.model,
                    part: results.part,
                    fullText: "Area OCR"
                })
            });

            status.innerText = "保存完了！";
        } catch (e) {
            status.innerText = "エラー発生";
        }

        setTimeout(() => {
            previewImg.style.display = 'none';
            btn.disabled = false;
            status.innerText = "準備完了";
        }, 1500);
    };

    window.onload = initCamera;
</script>
</body>
</html>
